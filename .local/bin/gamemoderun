#!/bin/bash

default_profile="balanced-bazzite"
performance_profile="throughput-performance-bazzite"
current_profile=$(tuned-adm active | awk '{print $NF}')

lact_performance_profile="Performance"
lact_default_profile="Balanced"

set_lact_profile() {
	local name=$1
	local json="{\"command\": \"set_profile\", \"args\": {\"name\":\"$name\"}}"
	echo $json | ncat -U /run/lactd.sock &>/dev/null
}

set_default_profiles() {
	echo "Switching to tuned profile: $current_profile"
	tuned-adm profile $current_profile

	echo "Switching to lact profile: $lact_default_profile"
	set_lact_profile $lact_default_profile
}

set_performance_profiles() {
	echo "Switching to tuned profile: $performance_profile"
	tuned-adm profile $performance_profile

	echo "Switching to lact profile: $lact_performance_profile"
	set_lact_profile $lact_performance_profile
}

if [ "$1" = "default" ]; then
	echo "Switching to default profiles:"
	set_default_profiles
	exit 0
fi

exit_app() {
	echo -e "\nInterrupted\n"
	set_default_profiles
	exit 0
}
trap 'exit_app' INT

echo "Active tuned profile: $current_profile"

set_performance_profiles

echo -e "Running application\n"
"$@"

exit_app
